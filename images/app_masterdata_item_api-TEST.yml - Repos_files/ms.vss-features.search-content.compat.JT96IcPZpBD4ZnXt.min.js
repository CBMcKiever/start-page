"use strict";define("VSS/Features/Search",["require","exports","VSS/Platform/Context","react","VSS/Core/Observable","VSS/Platform/Feature","VSS/Platform/Layout","VSSUI/Icon","VSSUI/Menu","VSS/Platform/Util/DOM","VSSUI/Util","VSS/Platform/Components/Format"],function(e,t,r,n,o,s,i,a,c,l,h,p){var u,d,v,m,f;u=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.AccountLabel="This organization",t.Resources.ExecuteSearch="Get search results",t.Resources.Global="Global",t.Resources.HelpNoSuggestions="No suggestions",t.Resources.ProjectLabel="This project",t.Resources.SearchChangeType="Change search type",t.Resources.SearchFindHelp="For more ways to search, see the {0}",t.Resources.SearchHelpLess="Show less",t.Resources.SearchHelpMore="Show more",t.Resources.SearchHelpPage="help page",t.Resources.SearchPageTitle="Search",t.Resources.SearchPlaceholder="Search",t.Resources.ClearText="Clear text",function(e){t.Coordinator={},Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.execute=function(e){var t=this.pageContext.getService("IVssContributionService");return t.getContributionAsync(e.providerId).then(function(r){if(r)return t.getService(e.providerId).then(function(t){if(t)return t.execute(e);throw new Error("Unable to create search provider service for '"+e.providerId+"'.")});throw new Error("Search provider '"+e.providerId+"' was not defined.")})},t}(r.VssService);r.Services.add("inprocess-search-coordinator",{serviceFactory:n})}(),function(e){d=t.SearchInputSearchInput={},Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r,n,o,s,i){var a=e.call(this)||this;return a.appendText=t,a.queryText=r,a.replaceText=n,a.setHelpVisibility=o,a.setHelpSearchProviderId=s,a.executeSearch=i,a}return __extends(t,e),t.prototype.textChanged=function(e){this.notify(e,"change")},t.prototype.keyDown=function(e){this.notify(e,"keyDown")},t}(o.Observable),l=function(e){function t(t,r){var o=e.call(this,t,r)||this;return o.availableProviders={},o.onBlur_Component=function(e){var t=e.relatedTarget||document.activeElement;o.setState({hasFocus:o.searchElement.current&&o.searchElement.current.contains(t)||o.helpElement.current&&o.helpElement.current.contains(t)||!!o.state.providerMenuItems,hideHelp:!(o.inputElement.current&&o.inputElement.current.contains(t)||o.helpElement.current&&o.helpElement.current.contains(t))})},o.onChange=function(){if(null!==o.inputElement.current){var e=o.inputElement.current.value.length>0;o.setState({hideHelp:!1,contentAvailable:e,hasFocus:!0,helpSearchProviderId:void 0,helpSearchProvider:void 0}),o.searchInput.textChanged(o.inputElement.current.value)}},o.onFocus_Component=function(){o.state.hasFocus||o.setState({hasFocus:!0})},o.onFocus_Input=function(){o.state.hasFocus||(o.setState({hasFocus:!0,hideHelp:!1}),o.props.onInputFocus&&o.props.onInputFocus())},o.onProvidersDismiss=function(){o.setState({hasFocus:!!o.searchElement.current&&o.searchElement.current.contains(document.activeElement),hideHelp:!1,providerMenuItems:void 0})},o.onKeyDown_Help=function(e){if(27===e.which)o.focus();else if(38===e.which){var t=e.target||document.activeElement;o._getFirstFocusElementInHelpDropdown()===t&&(o.focus(),e.stopPropagation())}},o.onKeyDown_Input=function(e){if(13===e.which)o.executeSearch(e.ctrlKey);else if(27===e.which)o.state.hideHelp||(o.setState({hideHelp:!0}),e.preventDefault());else if(40===e.which)if(o.sendKeysToHelp())o.searchInput.keyDown(e.key);else{var t=o._getNextToFocusedElement()||o._getFirstFocusElementInHelpDropdown();t&&t.focus(),e.stopPropagation(),e.preventDefault()}else 38===e.which&&o.sendKeysToHelp()&&(o.searchInput.keyDown(e.key),e.preventDefault())},o.sendKeysToHelp=function(){return!0===o.props.sendKeysToHelp},o.onKeyDown_Provider=function(e){13!==e.which&&32!==e.which&&40!==e.which||o.showProviderMenu()},o.onKeyDown_Search=function(e){13!==e.which&&32!==e.which||o.executeSearch(e.ctrlKey)},o.onProviderChanged=function(e){o.setState({customProviderSelected:!0,selectedProviderId:e})},o.onSearchClicked=function(e){o.executeSearch(e.ctrlKey)},o.showProviderMenu=function(){for(var e=[],t=function(t){t!=o.state.selectedProviderId&&e.push({id:t,onActivate:function(){o.setState({customProviderSelected:!0,selectedProviderId:t}),o.focus()},text:o.availableProviders[t].providerName})},r=0,n=Object.keys(o.availableProviders);r<n.length;r++){t(n[r])}o.setState({hideHelp:!0,providerMenuItems:e})},o.onKeyDown_ClearText=function(e){13!==e.which&&32!==e.which||o.clearInput()},o.clearInput=function(){o.replaceOrAppendText("",!1)},o.replaceOrAppendText=function(e,t,r,n){if(void 0===t&&(t=!0),void 0===r&&(r=!0),null!==o.inputElement.current){var s=t?o.inputElement.current.value+(o.inputElement.current.value.length>0?" ":"")+e:e;o.inputElement.current.value=s,o.inputElement.current.selectionStart=o.inputElement.current.selectionEnd=o.inputElement.current.value.length,o.setState({contentAvailable:!0}),r&&o.searchInput.textChanged(o.inputElement.current.value),o.focus()}},o.state={},o.state=o.processProviders(t),o.searchElement=n.createRef(),o.inputElement=n.createRef(),o.helpElement=n.createRef(),o}return __extends(t,e),t.prototype.render=function(){var e=this.props.placeholderText||this.state.selectedProviderId&&this.availableProviders[this.state.selectedProviderId]&&this.availableProviders[this.state.selectedProviderId].placeholder||u.SearchPlaceholder,t=(this.inputElement.current?this.inputElement.current.value:"")&&!h()&&!p(),r=null;if(!this.state.hideHelp&&this.state.hasFocus&&this.state.shownProvider&&this.state.shownProvider.help){var o=this.state.shownProvider.help(this.searchInput);if(o){var l=this.props.dropdownGapSize,d=s.isFeatureEnabled(this.context.pageContext,"ms.vss-tfs-web.enable-search-suggestions",!1)?151:l;r=n.createElement(i.WrappedComponent,Object.assign({dependencies:["ms.vss-features.ui-content"],wrappedType:"callout"},{anchorOffset:{horizontal:d,vertical:l},anchorElement:this.searchElement.current,anchorOrigin:{horizontal:"end",vertical:"end"},calloutOrigin:{horizontal:"end",vertical:"start"},className:"search-help-callout search-callout",contentShadow:!0,focuszoneProps:{focusOnMount:!1,disabled:!1,direction:2,circularNavigation:!0}}),n.createElement("div",{id:this.props.helpId,className:this.props.helpClassName,ref:this.helpElement,onKeyDown:this.onKeyDown_Help},o))}}return this.state.selectedProviderId?n.createElement("div",{ref:this.searchElement,className:i.css("flex-cell","search",this.state.hasFocus?" focus":""),onBlur:this.onBlur_Component,onFocus:this.onFocus_Component,"aria-label":this.props.ariaLabel,role:"search"},this.props.showSearchIcon&&n.createElement("div",{className:"search-icon cursor-pointer",onClick:this.onSearchClicked,onKeyDown:this.onKeyDown_Search,role:"button",tabIndex:this.state.contentAvailable?0:void 0,title:u.ExecuteSearch},n.createElement(a.Icon,{iconName:"Search"})),n.createElement("input",{ref:this.inputElement,className:"search-input",onChange:this.onChange,onFocus:this.onFocus_Input,onKeyDown:this.onKeyDown_Input,placeholder:e,spellCheck:this.props.spellCheck,"aria-label":this.props.inputAriaLabel||e,type:"text"}),t&&n.createElement("div",{className:"clear-text-icon cursor-pointer",role:"button",tabIndex:this.state.contentAvailable?0:void 0,onKeyDown:this.onKeyDown_ClearText,title:u.ClearText,onClick:this.clearInput},n.createElement(a.Icon,{iconName:"ChromeClose"})),this.props.showSearchProviders&&Object.keys(this.availableProviders).length>1?n.createElement("div",{"aria-owns":this.state.providerMenuItems&&"search-providers-menu",className:"search-icon",onClick:this.showProviderMenu,onKeyDown:this.onKeyDown_Provider,role:"button",tabIndex:0,title:u.SearchChangeType},n.createElement("span",{className:"ms-Icon ms-Icon--ChevronDown ms-SearchBox-icon"})):null,r,this.state.providerMenuItems&&this.searchElement.current?n.createElement(c.ContextualMenu,{anchorElement:this.searchElement.current,menuProps:{id:"search-providers-menu",items:this.state.providerMenuItems},onDismiss:this.onProvidersDismiss}):null):null},t.prototype.componentDidMount=function(){var t=this;e.prototype.componentDidMount.call(this),this.context.pageContext.getService("IVssSearchService").subscribe(this.onProviderChanged,"providerSelected"),this.props.initialQueryText&&this.setQueryText(this.props.initialQueryText),this.searchInput=new r(function(e,r){t.replaceOrAppendText(e,!0,r)},function(){return null!==t.inputElement.current?t.inputElement.current.value:""},function(e,r){t.replaceOrAppendText(e,!1,r)},function(e){t.setState({hideHelp:e})},function(e){e&&t.context.pageContext.getService("IVssContributionService").getService(e).then(function(r){r&&t.setState({helpSearchProviderId:e,helpSearchProvider:r})})},function(e){t.executeSearch(e)}),this.props.componentRef&&this.props.componentRef(this)},t.prototype.componentWillUnmount=function(){this.context.pageContext.getService("IVssSearchService").unsubscribe(this.onProviderChanged,"providerSelected"),e.prototype.componentWillUnmount.call(this)},t.prototype.componentWillReceiveProps=function(e){e.selectedProviderId&&e.selectedProviderId!==this.state.selectedProviderId&&this.setState(this.processProviders(e))},t.prototype.hasFocus=function(){return this.state.hasFocus},t.prototype.focus=function(){var e=this.inputElement.current;e&&(e.focus(),e.selectionStart=e.selectionEnd=e.value.length)},t.prototype.blur=function(){this.inputElement.current&&this.inputElement.current.blur()},t.prototype.setQueryText=function(e){this.inputElement.current&&this.inputElement.current.value!==e&&(this.inputElement.current.value=e)},t.prototype.getQueryText=function(){return this.inputElement.current?this.inputElement.current.value:""},t.prototype.setState=function(t){var r=this;e.prototype.setState.call(this,t,function(){if(r.state.selectedProviderId&&r.state.selectedProviderId!=r.state.shownProviderId){var e=r.context.pageContext.getService("IVssContributionService"),t=r.state.selectedProviderId;e.getService(t).then(function(e){e&&r.setState({shownProvider:e,shownProviderId:t})})}})},t.prototype.executeSearch=function(e){var t=this;if(null!==this.inputElement.current){var r=this.inputElement.current.value,n=this.state.shownProviderId,o=this.state.shownProvider;if(this.state.helpSearchProvider&&this.state.helpSearchProviderId&&(o=this.state.helpSearchProvider,n=this.state.helpSearchProviderId),n&&o){var s={queryText:r,providerId:n,openInNewWindow:e};o.getQuery&&(s=o.getQuery(s)),o.performAction?o.performAction(s).then(function(e){e||t.executeSearchAndHideHelp(s)},function(){return t.executeSearchAndHideHelp(s)}):this.executeSearchAndHideHelp(s)}}},t.prototype.executeSearchAndHideHelp=function(e){e.queryText&&(this.props.executeSearch(e),this.setState({hideHelp:!0}))},t.prototype.processProviders=function(e){var t,r,n=this.context.pageContext.getService("IVssSearchService"),o=n.getProviders();for(var s in this.availableProviders={},o)e.availableProviderIds&&-1==e.availableProviderIds.indexOf(s)||(this.availableProviders[s]=o[s]);if(e.selectedProviderId&&this.availableProviders[e.selectedProviderId]&&(r=e.selectedProviderId,t=!0),!t||!r){var i=n.getSelectedProvider();i&&(r=i)}return{customProviderSelected:t,selectedProviderId:r}},t.prototype._getNextToFocusedElement=function(){return this.helpElement.current?this.helpElement.current.querySelector("tr.focused + tr[tabIndex='-1']"):null},t.prototype._getFirstFocusElementInHelpDropdown=function(){return this.helpElement.current?this.helpElement.current.querySelector("li[tabIndex='-1']")||this.helpElement.current.querySelector("tr[tabIndex='-1']"):null},t}(i.VssComponent);function h(){var e=window.navigator.userAgent.toLowerCase();return!!/msie ([\d+.]+)/i.exec(navigator.userAgent)||-1!==e.indexOf("trident")}function p(){return!!/edge\/([\d+.]+)/i.exec(navigator.userAgent)}t.SearchInputSearchInput.SearchInputComponent=l,t.SearchInputSearchInput.isIE=h,t.SearchInputSearchInput.isEdge=p}(),function(e){v=t[e]={},Object.defineProperty(t,"__esModule",{value:!0}),function(r){for(var n in r)t[e].hasOwnProperty(n)||(t[e][n]=r[n])}(d)}("SearchInput"),function(e){t.ExpandableSearchBoxExpandableSearchBox={},Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r){var n=e.call(this,t)||this;n._isSearchSuggestionsEnabled=!1,n._project=!1,n._onExecuteSearch=function(e){n.context.pageContext.getService("IVssSearchService").execute(e)},n._dispatchEvent=function(e){var t=document.createEvent("Event");t.initEvent(e,!1,!0),window.dispatchEvent(t)},n._expandSearchBox=function(){n._publishTelemetry(),n._dispatchEvent("searchExpanded"),n.setState({isExpanded:!0})},n._collapseSearchBox=function(e){n._dispatchEvent("searchCollapsed"),n.setState({isExpanded:!1,selectedProviderId:e?void 0:n.state.selectedProviderId})},n._onBlur=function(e){var t=e.relatedTarget||document.activeElement;n._searchHeader&&!l.contains(n._searchHeader,t)&&n._collapseSearchBox()},n._onSearchTabLoaded=function(e){var t=e.detail;t&&t.providerId&&n.setState({selectedProviderId:t.providerId,isExpanded:!1})},n._publishTelemetry=function(){var e=n.context.pageContext.getService("IVssTelemetryService"),t=n.context.pageContext.getService("IVssNavigationService").getDisplayedNavigation(),r=t.length>=3?t[2]:"",o=t.length>=4?t[3]:"";e.publishEvent("WebPlatform","L1SearchBarFocussed",{launchPoint_HubGroup:r,launchPoint_hub:o})},n.state={isExpanded:!1,selectedProviderId:void 0};var o=r.pageContext.getService("IVssSearchService");n._providersAvailable=Object.keys(o.getProviders()).length>0,n._isSearchSuggestionsEnabled=s.isFeatureEnabled(r.pageContext,"ms.vss-tfs-web.enable-search-suggestions",!1);var i=r.pageContext.getService("IVssContributionService").getData("ms.vss-tfs-web.page-data");return i&&i.project&&(n._project=!0),n}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.state.isExpanded;return this._providersAvailable?n.createElement("div",{className:h.css("flex","expandable-search-header"),ref:function(t){return e._searchHeader=t},onBlur:this._onBlur,"aria-owns":h.css(t&&"searchBox-dropDown")},t?n.createElement("label",{className:"search-context--label flex-self-center"},this._project?u.ProjectLabel:u.AccountLabel):null,n.createElement(v.SearchInputComponent,{executeSearch:this._onExecuteSearch,selectedProviderId:this.state.selectedProviderId,dropdownGapSize:0,helpClassName:h.css("expandable-header-search-help",this._isSearchSuggestionsEnabled&&"instant-search"),helpId:"searchBox-dropDown",showSearchProviders:!1,placeholderText:u.SearchPlaceholder,showSearchIcon:!0,spellCheck:!1,onInputFocus:this._expandSearchBox,componentRef:function(t){e._searchInputComponent=t}})):n.createElement("div",{className:"search-placeholder"})},t.prototype.componentDidMount=function(){e.prototype.componentDidMount.call(this),this.addEventListener(document.body,"searchTabLoaded",this._onSearchTabLoaded),this.registerShortcut()},t.prototype.componentWillUnmount=function(){e.prototype.componentWillUnmount.call(this),this._dispatchEvent("searchCollapsed")},t.prototype.componentDidUpdate=function(t,r){e.prototype.componentDidUpdate.call(this,t,r),!this.state.isExpanded&&this._searchInputComponent&&this._searchInputComponent.blur()},t.prototype.componentWillReceiveProps=function(t){e.prototype.componentWillReceiveProps.call(this,t);var r=this.context.pageContext.getService("IVssSearchService");this._providersAvailable=Object.keys(r.getProviders()).length>0},t.prototype.registerShortcut=function(){var e=this,t=this.context.pageContext.getService("IVssNavigationService").getDisplayedNavigation(),r=t.length>=3?t[2]:"";"ms.vss-search-platform.search-hidden-collection-hub-group"!==r&&"ms.vss-search-platform.search-hidden-project-hub-group"!==r&&this.context.pageContext.getService("IVssKeyboardShortcutService").registerShortcut(u.Global,{combos:["/","s"],description:u.SearchPlaceholder,action:function(){e._searchInputComponent&&e._searchInputComponent.focus()}})},t}(i.VssComponent);i.VssComponent.register("expandableSearchHeader",r)}(),function(e){m=t.SearchHeaderSearchHeader={},Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,r){var n=e.call(this,t,r)||this;n.onExecuteSearch=function(e){n.context.pageContext.getService("IVssSearchService").execute(e)};var o=r.pageContext.getService("IVssSearchService");return n.providersAvailable=Object.keys(o.getProviders()).length>0,n}return __extends(t,e),t.prototype.render=function(){return this.providersAvailable?n.createElement("div",{className:"flex search-header"},n.createElement(v.SearchInputComponent,{executeSearch:this.onExecuteSearch,dropdownGapSize:0,helpClassName:"header-search-help",showSearchProviders:!0,showSearchIcon:!0,spellCheck:!1})):n.createElement("div",{className:"search-placeholder"})},t.prototype.componentWillReceiveProps=function(e){var t=this.context.pageContext.getService("IVssSearchService");this.providersAvailable=Object.keys(t.getProviders()).length>0},t}(i.VssComponent);t.SearchHeaderSearchHeader.SearchHeaderInput=r,i.VssComponent.register("searchInput",r)}(),function(e){t[e]={},Object.defineProperty(t,"__esModule",{value:!0}),function(r){for(var n in r)t[e].hasOwnProperty(n)||(t[e][n]=r[n])}(m)}("SearchHeader"),function(e){f=t.SearchHelpSearchHelp={},Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(){var t=e.apply(this,arguments)||this;return t.onKeyDown=function(e){if((38===e.which||40===e.which)&&null!==t.helpElement){var r=document.activeElement,n=t.helpElement.querySelectorAll("[tabIndex='-1']"),o=0;for(o=0;o<n.length&&r!==n[o];o++);o===n.length&&(o=-1),38===e.which?--o<0&&(o=n.length-1):++o===n.length&&(o=0),o>=0&&o<n.length&&n[o].focus(),e.preventDefault()}},t.onMouseDown=function(e){e.preventDefault()},t}return __extends(t,e),t.prototype.render=function(){var e=this;return n.createElement("div",{ref:function(t){e.helpElement=t},className:"search-help",onKeyDown:this.onKeyDown,onMouseDown:this.onMouseDown},this.props.filterGroups.map(function(t,r){return n.createElement(o,{key:r,filterGroup:t,searchInput:e.props.searchInput,filterText:e.props.filterText,onItemActivated:e.props.onItemActivated,onRenderFilterText:e.props.onRenderFilterText})}),this.props.helpLink?n.createElement("div",null,n.createElement(p.FormatComponent,{format:u.SearchFindHelp},n.createElement("a",{className:"search-link",href:this.props.helpLink,tabIndex:-1,target:"vss-search-help"},u.SearchHelpPage))):null)},t.prototype.focus=function(){var e=null!==this.helpElement?this.helpElement.querySelector("[tabIndex='-1']"):null;e&&e.focus()},t}(n.Component);t.SearchHelpSearchHelp.SearchHelpComponent=r;var o=function(e){function t(t){var r=e.call(this,t)||this;return r.onKeyDown=function(e){13===e.which&&r.toggleExpander()},r.toggleExpander=function(){r.state.expanded?r.setState({expanded:!1,visibleCount:10}):r.setState({expanded:!0,visibleCount:Number.MAX_SAFE_INTEGER})},r.state={expanded:!1,visibleCount:10},r}return __extends(t,e),t.prototype.render=function(){var e=this;return n.createElement("div",null,n.createElement("div",null,this.props.filterGroup.caption?n.createElement("span",{className:"search-filter-caption"},this.props.filterGroup.caption):null,this.props.filterGroup.example?n.createElement("span",{className:"search-filter-example"},this.props.filterGroup.example):null),n.createElement("ul",{className:"search-filter-list "+(this.props.filterGroup.singleLine?"compact":"detailed")},this.props.filterGroup.filters.map(function(t,r){return r>=e.state.visibleCount?null:n.createElement(s,{key:r,filter:t,searchInput:e.props.searchInput,filterText:e.props.filterText,onItemActivated:e.props.onItemActivated,onRenderFilterText:e.props.onRenderFilterText})}),this.props.filterGroup.filters.length>=10?n.createElement("li",{className:"search-filter-item search-filter-expander",onClick:this.toggleExpander,onKeyDown:this.onKeyDown,tabIndex:-1},n.createElement(a.Icon,{className:"search-filter-expander-icon",iconName:this.state.expanded?"ChevronUpSmall":"ChevronDownSmall"}),n.createElement("span",null,this.state.expanded?u.SearchHelpLess:u.SearchHelpMore)):null,this.props.filterGroup.footer?n.createElement("li",{className:"search-filter-item search-filter-footer"},this.props.filterGroup.footer):null,0===this.props.filterGroup.filters.length?n.createElement("li",{className:"help-no-suggestion"},u.HelpNoSuggestions):null))},t}(n.Component),s=function(e){function t(){var t=e.apply(this,arguments)||this;return t.onActivate=function(){null!=t.listItem&&t.listItem.focus();var e=t.props,r=e.filter,n=e.searchInput,o=e.onItemActivated,s=t.props.searchInput.queryText(),i=r.shortcutText||r.text,a=r.getSuggestedText?r.getSuggestedText(s,i):i;r.replaceTextOnActivation?n.replaceText(a):n.appendText(a),o&&o(r)},t.onKeyDown=function(e){13===e.which&&t.onActivate()},t}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.onRenderFilterText,o=t.filter,s=t.filterText;return n.createElement("li",{ref:function(t){e.listItem=t},className:"search-filter-item",onClick:this.onActivate,onKeyDown:this.onKeyDown,tabIndex:-1},n.createElement("div",{className:"search-filter-text"},r?r(o,s):o.text),this.props.filter.hint?n.createElement("div",{className:"search-filter-hint"},this.props.filter.hint):null)},t}(n.Component)}(),function(e){t[e]={},Object.defineProperty(t,"__esModule",{value:!0}),function(r){for(var n in r)t[e].hasOwnProperty(n)||(t[e][n]=r[n])}(f)}("SearchHelp")},["Resources","Coordinator","SearchInput/SearchInput","SearchInput","ExpandableSearchBox/ExpandableSearchBox","SearchHeader/SearchHeader","SearchHeader","SearchHelp/SearchHelp","SearchHelp"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-features.search-content"}}));